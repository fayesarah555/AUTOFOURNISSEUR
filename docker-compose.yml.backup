version: "3.9"

services:
  # ==============================================
  # DATABASE - MariaDB
  # ==============================================
  db:
    image: mariadb:11.4
    container_name: autofournisseur_db
    restart: unless-stopped
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
      TZ: ${TZ}
    volumes:
      - db_data:/var/lib/mysql
      - ./back/config/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./back/config/seed_pallets.sql:/docker-entrypoint-initdb.d/02-seed_pallets.sql:ro
    ports:
      - "${DB_PORT}:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${DB_USER}", "-p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - autofournisseur_network

  # ==============================================
  # BACKEND - Node.js API
  # ==============================================
  back:
    build:
      context: ./back
      dockerfile: Dockerfile
    container_name: autofournisseur_back
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Node
      NODE_ENV: ${NODE_ENV}
      PORT: 8080
      
      # CORS
      CLIENT_ORIGIN: ${CLIENT_ORIGIN}
      
      # Session
      SESSION_NAME: ${SESSION_NAME}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE}
      SESSION_SAME_SITE: ${SESSION_SAME_SITE}
      SESSION_MAX_AGE_MS: ${SESSION_MAX_AGE_MS}
      SECRET_KEY: ${SECRET_KEY}
      
      # Demo User
      DEMO_USER_ID: ${DEMO_USER_ID}
      DEMO_USER_PASSWORD: ${DEMO_USER_PASSWORD}
      
      # Database
      DB_HOST: db
      DB_PORT: 3306
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      
      # Timezone
      TZ: ${TZ}
    ports:
      - "${BACK_PORT}:8080"
    volumes:
      - back_public:/app/public
    networks:
      - autofournisseur_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==============================================
  # FRONTEND - React App
  # ==============================================
  front:
    build:
      context: ./front
      dockerfile: Dockerfile
      args:
        # IMPORTANT : Chemin relatif pour que les requÃªtes passent par nginx
        REACT_APP_API_BASE_URL: ${FRONT_API_BASE_URL}
    container_name: autofournisseur_front
    restart: unless-stopped
    depends_on:
      - back
    ports:
      - "${FRONT_PORT}:80"
    networks:
      - autofournisseur_network

  # ==============================================
  # REVERSE PROXY - Nginx
  # ==============================================
  nginx:
    image: nginx:1.27-alpine
    container_name: autofournisseur_nginx
    restart: unless-stopped
    depends_on:
      - front
      - back
    ports:
      - "80:80"
    volumes:
      - ./infra/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - autofournisseur_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

# ==============================================
# VOLUMES
# ==============================================
volumes:
  db_data:
    driver: local
  back_public:
    driver: local

# ==============================================
# NETWORKS
# ==============================================
networks:
  autofournisseur_network:
    driver: bridge
